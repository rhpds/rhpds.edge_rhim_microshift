---
# Mirror container images to local registry
# Optional: username and password variables (from secrets) for authenticated registries

- name: Login to Quay.io (if credentials provided)
  containers.podman.podman_login:
    username: "{{ username }}"
    password: "{{ password }}"
    registry: quay.io
  when:
    - username is defined
    - password is defined
    - username | length > 0
    - password | length > 0
  failed_when: false
  delegate_to: registry

- name: Pull and mirror images to local registry
  ansible.builtin.shell: |
    podman pull {{ item }}
    podman tag {{ item }} localhost:5000/{{ item | regex_replace('^.*?/', '') }}
    podman push localhost:5000/{{ item | regex_replace('^.*?/', '') }}
  loop: "{{ registry_images_to_mirror }}"
  register: r_mirror_images
  retries: 3
  delay: 10
  until: r_mirror_images is success
  delegate_to: registry

- name: Display mirrored images summary
  ansible.builtin.debug:
    msg:
      - "Successfully mirrored {{ registry_images_to_mirror | length }} images to local registry"
      - "Images available at: registry:5000/<image-name>"
