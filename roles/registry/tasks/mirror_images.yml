---
# Mirror container images to local registry
# Requires: ocp4_pull_secret or ocp4_token variable (from secrets)

- name: Set pull secret variable
  ansible.builtin.set_fact:
    _pull_secret: "{{ ocp4_pull_secret | default(ocp4_token) }}"
  when: ocp4_pull_secret is defined or ocp4_token is defined
  delegate_to: registry

- name: Create pull secret auth file for podman
  ansible.builtin.copy:
    content: "{{ _pull_secret }}"
    dest: /tmp/pull-secret.json
    mode: '0600'
  when: _pull_secret is defined
  no_log: true
  delegate_to: registry

- name: Pull and mirror images to local registry
  ansible.builtin.shell: |
    export REGISTRY_AUTH_FILE=/tmp/pull-secret.json
    # Pull the image by digest
    podman pull {{ item }}
    # Get the image ID
    IMAGE_ID=$(podman images --filter reference={{ item }} --format "{{ '{{' }}.ID{{ '}}' }}" | head -1)
    # Extract short digest for tag name (last 12 chars of sha256)
    SHORT_DIGEST=$(echo "{{ item }}" | grep -o 'sha256:[a-f0-9]*' | cut -d: -f2 | cut -c1-12)
    # Create tag name from image name
    IMAGE_NAME=$(echo "{{ item }}" | sed 's|@sha256:.*||' | sed 's|.*/||')
    # Tag with digest-based name
    podman tag ${IMAGE_ID} localhost:5000/${IMAGE_NAME}:${SHORT_DIGEST}
    # Push to local registry
    podman push localhost:5000/${IMAGE_NAME}:${SHORT_DIGEST}
  loop: "{{ registry_images_to_mirror }}"
  register: r_mirror_images
  retries: 3
  delay: 10
  until: r_mirror_images is success
  delegate_to: registry

- name: Display mirrored images summary
  ansible.builtin.debug:
    msg:
      - "Successfully mirrored {{ registry_images_to_mirror | length }} images to local registry"
      - "Images available at: registry:5000/<image-name>"
