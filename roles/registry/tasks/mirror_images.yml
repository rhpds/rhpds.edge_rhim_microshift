---
# Mirror container images to local registry
# Requires: ocp4_pull_secret or ocp4_token variable (from secrets)

- name: Set pull secret variable
  ansible.builtin.set_fact:
    _pull_secret: "{{ ocp4_pull_secret | default(ocp4_token) }}"
  when: ocp4_pull_secret is defined or ocp4_token is defined
  delegate_to: registry

- name: Create pull secret auth file for podman
  ansible.builtin.copy:
    content: "{{ _pull_secret }}"
    dest: /tmp/pull-secret.json
    mode: '0600'
  when: _pull_secret is defined
  no_log: true
  delegate_to: registry

- name: Login to registry.redhat.io for LVMS images
  ansible.builtin.shell: |
    podman login registry.redhat.io -u "{{ registry_credentials_username }}" -p "{{ registry_credentials_password }}"
  when: registry_credentials_username is defined and registry_credentials_password is defined
  no_log: true
  delegate_to: registry

- name: Pull and mirror images to local registry
  ansible.builtin.shell: |
    export REGISTRY_AUTH_FILE=/tmp/pull-secret.json
    SOURCE_IMAGE="{{ item }}"
    # Extract repository path by removing registry hostname (everything up to first slash)
    # Examples:
    #   quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:... -> openshift-release-dev/ocp-v4.0-art-dev@sha256:...
    #   registry.redhat.io/lvms4/lvms-rhel9-operator@sha256:... -> lvms4/lvms-rhel9-operator@sha256:...
    #   docker.io/library/wordpress:6.2.1-apache -> library/wordpress:6.2.1-apache
    DEST_IMAGE="localhost:5000/{{ item | regex_replace('^[^/]+/', '') }}"
    
    # Determine if image should be copied with --all flag (multi-arch images)
    if [[ "${SOURCE_IMAGE}" == *"lvm"* || "${SOURCE_IMAGE}" == *"ubi"* ]]; then
      skopeo copy --all --preserve-digests --dest-tls-verify=false \
        "docker://${SOURCE_IMAGE}" "docker://${DEST_IMAGE}"
    else
      skopeo copy --preserve-digests --dest-tls-verify=false \
        "docker://${SOURCE_IMAGE}" "docker://${DEST_IMAGE}"
    fi
  loop: "{{ registry_images_to_mirror }}"
  loop_control:
    label: "{{ item }}"
  register: r_mirror_images
  retries: 3
  delay: 10
  until: r_mirror_images is success
  delegate_to: registry

- name: Display mirrored images summary
  ansible.builtin.debug:
    msg:
      - "Successfully mirrored {{ registry_images_to_mirror | length }} images to local registry"
      - "Images available at: registry:5000/<image-name>"
