---
- name: Configuration file for local mirrors
  ansible.builtin.copy:
    content: |
      # Mirror for quay.io
      [[registry]]
      location = "quay.io"

        [[registry.mirror]]
        location = "registry:5000"
        insecure = true

      # Mirror for registry.redhat.io
      [[registry]]
      location = "registry.redhat.io"

        [[registry.mirror]]
        location = "registry:5000"
        insecure = true

      # Mirror for docker.io
      [[registry]]
      location = "docker.io"

        [[registry.mirror]]
        location = "registry:5000"
        insecure = true
    dest: /etc/containers/registries.conf.d/99-mirrors.conf
    mode: '0644'

- name: Overwrite container policy to insecure
  ansible.builtin.copy:
    content: '{"default": [{"type": "insecureAcceptAnything"}]}'
    dest: /etc/containers/policy.json
    mode: '0644'
    backup: true

- name: Clone bootc-embeeded-containers repository
  ansible.builtin.git:
    repo: https://github.com/arthur-r-oliveira/bootc-embeeded-containers.git
    version: rhpds
    dest: /home/lab-user/bootc-embeeded-containers
    force: true
  become: true
  become_user: lab-user

- name: Remove excluded files and directories from cloned repository
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /home/lab-user/bootc-embeeded-containers/ansible
    - /home/lab-user/bootc-embeeded-containers/create-ks.sh
    - /home/lab-user/bootc-embeeded-containers/.git
  become: true
  become_user: lab-user
